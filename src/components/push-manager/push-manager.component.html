<div class="min-h-full bg-gray-50 flex flex-col">
  @if (view() === 'dashboard') {
    <div class="p-6 lg:p-10 max-w-7xl mx-auto animate-fade-in space-y-8">
      <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
          <h1 class="text-3xl font-semibold text-gray-900 tracking-tight">Painel de Comunicação</h1>
          <p class="text-gray-500 text-sm mt-1">Gestão de engajamento e métricas de conversão.</p>
        </div>
        <button
          (click)="view.set('sender')"
          class="bg-purple-700 hover:bg-purple-800 text-white px-6 py-2.5 rounded-full font-medium flex items-center justify-center gap-2 transition-all shadow-sm hover:shadow-md active:scale-95 text-sm">
          <span class="material-symbols-outlined text-base">add</span>
          CRIAR NOVO PUSH
        </button>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
        <div class="bg-white p-6 rounded-2xl border border-gray-200 shadow-sm flex flex-col gap-4 relative overflow-hidden group">
          <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:scale-110 transition-transform">
            <span class="material-symbols-outlined text-4xl text-purple-600">notifications</span>
          </div>
          <p class="text-xs font-bold text-gray-500 uppercase tracking-widest">Total Disparos</p>
          <div class="flex items-baseline gap-2">
            <span class="text-4xl font-bold text-gray-900">36.450</span>
            <span class="text-xs font-medium text-green-600 bg-green-50 px-2 py-0.5 rounded-full">+12%</span>
          </div>
        </div>

        <div class="bg-white p-6 rounded-2xl border border-gray-200 shadow-sm flex flex-col gap-4 relative overflow-hidden group">
          <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:scale-110 transition-transform">
            <span class="material-symbols-outlined text-4xl text-purple-700">payments</span>
          </div>
          <p class="text-xs font-bold text-gray-500 uppercase tracking-widest">Investimento Total</p>
          <div class="flex items-baseline gap-2">
            <span class="text-4xl font-bold text-gray-900">R$ 4.350</span>
            <span class="text-gray-400 text-sm font-medium">,75</span>
          </div>
        </div>

        <div class="bg-white p-6 rounded-2xl border border-gray-200 shadow-sm flex flex-col gap-4 relative overflow-hidden group">
          <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:scale-110 transition-transform">
            <span class="material-symbols-outlined text-4xl text-orange-600">query_stats</span>
          </div>
          <p class="text-xs font-bold text-gray-500 uppercase tracking-widest">ROI / Matrícula</p>
          <div class="flex items-baseline gap-2">
            <span class="text-4xl font-bold text-orange-600">R$ 3,52</span>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 gap-8">
        <div class="bg-white rounded-2xl border border-gray-200 shadow-sm overflow-hidden">
          <div class="px-6 py-4 border-b border-gray-100 flex items-center gap-3 bg-gray-50/30">
            <span class="material-symbols-outlined text-purple-600">event</span>
            <h2 class="text-base font-bold text-gray-800">Próximos Agendamentos</h2>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-left">
              <thead>
                <tr class="bg-white border-b border-gray-100">
                  <th class="px-6 py-4 text-xs font-bold text-gray-400 uppercase tracking-wider">Campanha</th>
                  <th class="px-6 py-4 text-xs font-bold text-gray-400 uppercase tracking-wider text-center">Data Programada</th>
                  <th class="px-6 py-4 text-xs font-bold text-gray-400 uppercase tracking-wider text-center">Contatos</th>
                  <th class="px-6 py-4 text-xs font-bold text-gray-400 uppercase tracking-wider text-right">Status</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-100">
                @for (scheduled of scheduledPushes; track scheduled.id) {
                  <tr class="hover:bg-gray-50/50 transition-colors">
                    <td class="px-6 py-4 font-medium text-gray-900">{{ scheduled.name }}</td>
                    <td class="px-6 py-4 text-gray-600 text-center text-sm">{{ scheduled.scheduledDate }}</td>
                    <td class="px-6 py-4 font-semibold text-gray-900 text-center text-sm">{{ scheduled.totalPush | number }}</td>
                    <td class="px-6 py-4 text-right">
                      <span class="inline-flex items-center px-3 py-1 rounded-full text-[10px] font-bold bg-amber-50 text-amber-700 border border-amber-100 uppercase tracking-tight">
                        {{ scheduled.status }}
                      </span>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        </div>

        <div class="bg-white rounded-2xl border border-gray-200 shadow-sm overflow-hidden">
          <div class="px-6 py-4 border-b border-gray-100 flex items-center gap-3 bg-gray-50/30">
            <span class="material-symbols-outlined text-purple-500">schedule</span>
            <h2 class="text-base font-bold text-gray-800">Histórico de Disparos</h2>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-left">
              <thead>
                <tr class="bg-white border-b border-gray-100">
                  <th class="px-6 py-4 text-xs font-bold text-gray-400 uppercase tracking-wider">Nome do Curso</th>
                  <th class="px-6 py-4 text-xs font-bold text-gray-400 uppercase tracking-wider text-center">Data Disparo</th>
                  <th class="px-6 py-4 text-xs font-bold text-gray-400 uppercase tracking-wider text-center">Disparos</th>
                  <th class="px-6 py-4 text-xs font-bold text-gray-400 uppercase tracking-wider text-right">Custo Total</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-100">
                @for (campaign of campaigns; track campaign.id) {
                  <tr class="hover:bg-gray-50/50 transition-colors">
                    <td class="px-6 py-4 font-medium text-gray-900">{{ campaign.courseName }}</td>
                    <td class="px-6 py-4 text-gray-600 text-center text-sm">{{ campaign.dispatchDate }}</td>
                    <td class="px-6 py-4 font-semibold text-gray-900 text-center text-sm">{{ campaign.totalPush | number }}</td>
                    <td class="px-6 py-4 font-bold text-purple-700 text-right text-sm">
                      R$ {{ campaign.investment | number:'1.2-2' }}
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  }

  @if (view() === 'sender') {
    <div class="flex flex-col min-h-[calc(100vh-64px)] animate-fade-in bg-[#fdfdfd]">
      <div class="bg-white border-b border-gray-200 px-10 py-4 flex items-center justify-between shadow-sm sticky top-0 z-30">
        <div class="flex items-center gap-8">
          @for (s of steps; track s.id; let idx = $index) {
            <div class="flex items-center gap-3 transition-opacity" [class.opacity-40]="step() < s.id">
              <div class="w-6 h-6 rounded-full flex items-center justify-center text-[10px] font-bold"
                [class.bg-green-600]="step() > s.id" [class.text-white]="step() >= s.id"
                [class.bg-purple-700]="step() === s.id" [class.text-white]="step() === s.id"
                [class.bg-gray-200]="step() < s.id" [class.text-gray-600]="step() < s.id">
                @if(step() > s.id) {
                  <span class="material-symbols-outlined text-xs">check</span>
                } @else {
                  {{ s.id }}
                }
              </div>
              <div class="hidden lg:block">
                <p class="text-[11px] font-bold uppercase tracking-wider text-gray-900">{{ s.label }}</p>
                <p class="text-[11px] text-gray-500">{{ s.description }}</p>
              </div>
              @if (idx < steps.length - 1) {
                <div class="h-[1px] w-8 bg-gray-200"></div>
              }
            </div>
          }
        </div>

        <div class="flex items-center gap-3">
          <button (click)="handleBack()"
            class="px-6 py-2 rounded-full text-purple-700 font-semibold text-xs uppercase tracking-widest hover:bg-purple-50 transition-colors">
            Voltar
          </button>
          @if (step() < 4) {
            <button [disabled]="isStepDisabled(step()+1)" (click)="handleNext()"
              class="px-8 py-2.5 rounded-full bg-purple-700 text-white font-bold text-xs uppercase tracking-widest hover:bg-purple-800 transition-all disabled:opacity-40 shadow-sm">
              Avançar
            </button>
          } @else {
            <button [disabled]="isSubmitting()" (click)="finishPush()"
              class="px-8 py-2.5 rounded-full bg-green-600 text-white font-bold text-xs uppercase tracking-widest hover:bg-green-700 transition-all disabled:opacity-40 shadow-sm flex items-center gap-2">
              {{ isSubmitting() ? 'PROCESSANDO...' : 'FINALIZAR DISPARO' }}
            </button>
          }
        </div>
      </div>

      <div class="flex-1 p-6 lg:p-10 max-w-[1400px] mx-auto w-full space-y-6">
        @if (step() === 1) {
          <div class="grid grid-cols-1 xl:grid-cols-[1fr_1fr_0.9fr] gap-4 lg:divide-x lg:divide-gray-100">
            <div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-4 flex flex-col min-h-[520px]">
              <div class="flex items-center justify-between mb-3">
                <p class="text-xs uppercase tracking-wider text-gray-600 font-bold" style="color:#111827">Selecione o modelo</p>
                <span class="text-[11px] font-semibold text-gray-500 bg-gray-100 px-3 py-1 rounded-full">{{ templates.length }}</span>
              </div>
              <div class="overflow-y-auto space-y-2 pr-1" style="max-height: 520px;">
                <button *ngFor="let tpl of templates" (click)="setTemplate(tpl)"
                    class="w-full text-left border rounded-xl px-3 py-3 transition shadow-sm hover:shadow-md"
                    [class.border-purple-700]="selectedTemplate()?.id === tpl.id"
                    [class.bg-purple-50]="selectedTemplate()?.id === tpl.id">
                    <p class="text-sm font-semibold text-gray-900 mb-1" style="color:#0f172a">{{ tpl.name }}</p>
                    <p class="text-xs text-gray-700 line-clamp-2 whitespace-pre-wrap" style="color:#1f2937">{{ tpl.content }}</p>
                  </button>
              </div>
            </div>

            <div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-6 space-y-4 min-h-[520px]">
              <div class="flex items-center gap-2 text-sm font-semibold text-gray-900">
                <span class="material-symbols-outlined text-purple-600 text-base">tune</span>
                <span style="color:#0f172a">Parâmetros do Template</span>
              </div>
              @if (extractedVariables().length === 0) {
                <p class="text-xs text-gray-500" style="color:#6b7280">Selecione um template para preencher as variáveis.</p>
              } @else {
                <div class="space-y-3">
                  @for (v of extractedVariables(); track v) {
                    <label class="space-y-1 block">
                      <span class="text-[11px] font-semibold text-gray-600 uppercase tracking-wide" style="color:#374151">{{ formatVariableLabel(v) }}</span>
                      <input type="text" [ngModel]="variableValues()[v]" (ngModelChange)="setVariable(v, $event)"
                        class="w-full px-3 py-2 border rounded-lg focus:border-purple-700 focus:ring-purple-700 outline-none bg-gray-50"
                        [placeholder]="variablePlaceholder(v)" />
                    </label>
                  }
                </div>
              }
            </div>

            <div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-4 min-h-[520px] flex flex-col">
              <p class="text-xs uppercase tracking-wider text-gray-500 font-bold mb-3">Visualização real</p>
              @if (!selectedTemplate()) {
                <div class="bg-gray-100 rounded-3xl h-full flex flex-col items-center justify-center p-8 text-center border-2 border-dashed border-gray-300">
                  <span class="material-symbols-outlined text-4xl text-gray-300 mb-3">smartphone</span>
                  <p class="text-gray-400 font-medium text-sm">Selecione um template para visualizar</p>
                </div>
              } @else {
                <div class="bg-[#e5ddd5] rounded-3xl p-5 min-h-[360px] shadow-inner relative overflow-hidden flex flex-col">
                  <div class="flex items-center gap-3 mb-5 bg-white/50 p-3 rounded-2xl backdrop-blur-md border border-white/30 shadow-sm">
                    <div class="w-10 h-10 bg-[#25D366] rounded-full flex items-center justify-center text-white shadow-sm font-bold">W</div>
                    <div>
                      <p class="text-xs font-bold text-gray-800">WhatsApp Business</p>
                      <p class="text-[10px] text-gray-500">Online</p>
                    </div>
                  </div>
                  <div class="max-w-[90%] self-start">
                    <div class="bg-white p-4 rounded-tr-2xl rounded-br-2xl rounded-bl-2xl shadow-sm relative mb-2">
                      <p class="text-sm text-gray-800 leading-relaxed whitespace-pre-wrap">
                        {{ renderedTemplate()?.content }}
                      </p>
                      <p class="text-[10px] text-gray-400 text-right mt-1">10:45</p>
                      <div class="absolute -left-2 top-0 w-3 h-3 bg-white rotate-45 transform origin-top-right"></div>
                    </div>
                    @if (selectedTemplate()?.buttons?.length) {
                      @for (btn of selectedTemplate()?.buttons ?? []; track btn) {
                        <div class="bg-white border-t border-gray-50 rounded-xl py-3 px-4 shadow-sm flex items-center justify-center gap-2 mb-1.5 cursor-default hover:bg-gray-50 transition-colors">
                          <span class="material-symbols-outlined text-sm text-purple-700">open_in_new</span>
                          <span class="text-xs font-semibold text-purple-700 uppercase tracking-tight">{{ btn }}</span>
                        </div>
                      }
                    }
                  </div>
                </div>
              }
            </div>
          </div>
        }

        @if (step() === 2) {
          <div class="max-w-5xl mx-auto">
            <div class="bg-white rounded-2xl border border-gray-200 shadow-sm">
              <div class="flex items-center justify-between px-6 py-4 border-b border-gray-100">
                <div class="flex items-center gap-3">
                  <input type="text" placeholder="Pesquisar..." class="px-4 py-2 rounded-full border border-gray-200 text-sm w-64 focus:border-purple-700 focus:ring-purple-700 outline-none" />
                </div>
              </div>
              <div class="overflow-auto max-h-[520px]">
                <table class="w-full text-left text-sm">
                  <thead class="bg-gray-50 border-b border-gray-100 sticky top-0">
                    <tr>
                      <th class="px-6 py-3 w-10">
                        <input type="checkbox" aria-label="Selecionar todos" (change)="toggleAllContacts($any($event.target).checked)" />
                      </th>
                      <th class="px-6 py-3 text-[11px] font-black text-gray-500 uppercase tracking-widest">Nome</th>
                      <th class="px-6 py-3 text-[11px] font-black text-gray-500 uppercase tracking-widest">E-mail</th>
                      <th class="px-6 py-3 text-[11px] font-black text-gray-500 uppercase tracking-widest text-right">Telefone</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray-100">
                    @for (c of contacts(); track c.id) {
                      <tr class="hover:bg-gray-50 transition">
                        <td class="px-6 py-3">
                          <input type="checkbox" [checked]="c.selected" (change)="toggleContact(c.id)" aria-label="Selecionar contato" />
                        </td>
                        <td class="px-6 py-3 font-semibold text-gray-900">
                          <div class="flex items-center gap-2">
                            <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-purple-100 text-purple-700 text-xs font-bold">{{ c.nome.charAt(0) }}</span>
                            <span>{{ c.nome }}</span>
                          </div>
                        </td>
                        <td class="px-6 py-3 text-gray-700">{{ c.email || '—' }}</td>
                        <td class="px-6 py-3 text-right text-gray-700">
                          @if (c.erro) {
                            <span class="text-xs font-semibold text-red-600">{{ c.erro }}</span>
                          } @else {
                            {{ c.telefone }}
                          }
                        </td>
                      </tr>
                    } @empty {
                      <tr>
                        <td colspan="4" class="px-6 py-6 text-center text-sm text-gray-500">Nenhum contato carregado</td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        }

        @if (step() === 3) {
          <div class="max-w-3xl mx-auto">
            <div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-6 space-y-4">
              <h4 class="text-base font-semibold text-gray-900">Agendamento</h4>
              <div class="flex items-center gap-4 text-sm">
                <label class="flex items-center gap-2">
                  <input type="radio" name="push-link-type-3" [checked]="isLinkedToCourse()" (change)="isLinkedToCourse.set(true)" />
                  <span>Vincular a um curso</span>
                </label>
                <label class="flex items-center gap-2">
                  <input type="radio" name="push-link-type-3" [checked]="!isLinkedToCourse()" (change)="isLinkedToCourse.set(false)" />
                  <span>Campanha avulsa</span>
                </label>
              </div>

              @if (isLinkedToCourse()) {
                <label class="space-y-1 block">
                  <span class="text-xs font-semibold text-gray-600 uppercase tracking-wide">Curso</span>
                  <select [ngModel]="selectedCourseId()" (ngModelChange)="selectedCourseId.set($event)"
                    class="w-full px-3 py-2 border rounded-lg focus:border-purple-700 focus:ring-purple-700 outline-none">
                    <option value="" disabled>Selecione</option>
                    @for (c of campaigns; track c.id) {
                      <option [value]="c.id">{{ c.courseName }}</option>
                    }
                  </select>
                </label>
              } @else {
                <label class="space-y-1 block">
                  <span class="text-xs font-semibold text-gray-600 uppercase tracking-wide">Nome da campanha</span>
                  <input type="text" [ngModel]="campaignName()" (ngModelChange)="campaignName.set($event)"
                    class="w-full px-3 py-2 border rounded-lg focus:border-purple-700 focus:ring-purple-700 outline-none" />
                </label>
              }

              <label class="space-y-1 block">
                <span class="text-xs font-semibold text-gray-600 uppercase tracking-wide">Data do disparo</span>
                <input type="datetime-local" [ngModel]="dispatchDate()" (ngModelChange)="dispatchDate.set($event)"
                  class="w-full px-3 py-2 border rounded-lg focus:border-purple-700 focus:ring-purple-700 outline-none" />
              </label>
            </div>
          </div>
        }

        @if (step() === 4) {
          <div class="grid grid-cols-1 lg:grid-cols-[1fr_1fr] gap-6">
            <div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-6 space-y-4">
              <h4 class="text-base font-semibold text-gray-900">Revisão final</h4>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm text-gray-800">
                <div class="p-3 rounded-lg border border-gray-200">
                  <p class="text-xs uppercase text-gray-500 font-semibold">Template</p>
                  <p class="font-semibold">{{ selectedTemplate()?.name || '—' }}</p>
                </div>
                <div class="p-3 rounded-lg border border-gray-200">
                  <p class="text-xs uppercase text-gray-500 font-semibold">Contatos</p>
                  <p class="font-semibold">{{ contacts().length }} registros</p>
                </div>
                <div class="p-3 rounded-lg border border-gray-200">
                  <p class="text-xs uppercase text-gray-500 font-semibold">Vínculo</p>
                  <p class="font-semibold">{{ isLinkedToCourse() ? 'Curso' : 'Campanha avulsa' }}</p>
                </div>
                <div class="p-3 rounded-lg border border-gray-200">
                  <p class="text-xs uppercase text-gray-500 font-semibold">Curso/Campanha</p>
                  <p class="font-semibold">
                    {{ isLinkedToCourse() ? (selectedCourseId() || 'Selecione um curso') : (campaignName() || 'Defina a campanha') }}
                  </p>
                </div>
                <div class="p-3 rounded-lg border border-gray-200">
                  <p class="text-xs uppercase text-gray-500 font-semibold">Data</p>
                  <p class="font-semibold">{{ dispatchDate() || 'Não definido' }}</p>
                </div>
              </div>
              <div class="text-xs text-gray-500">Confirme os dados antes de disparar. Créditos e DDD internacional são calculados na execução.</div>
            </div>

            <div class="bg-white rounded-2xl border border-purple-200 shadow-sm p-4 space-y-3">
              <h4 class="text-sm font-semibold text-gray-900">Preview WhatsApp</h4>
              @if (!selectedTemplate()) {
                <div class="bg-gray-100 rounded-3xl h-full flex flex-col items-center justify-center p-8 text-center border-2 border-dashed border-gray-300">
                  <span class="material-symbols-outlined text-4xl text-gray-300 mb-3">smartphone</span>
                  <p class="text-gray-400 font-medium text-sm">Selecione um template para visualizar</p>
                </div>
              } @else {
                <div class="bg-[#e5ddd5] rounded-3xl p-5 min-h-[360px] shadow-inner relative overflow-hidden flex flex-col">
                  <div class="flex items-center gap-3 mb-5 bg-white/50 p-3 rounded-2xl backdrop-blur-md border border-white/30 shadow-sm">
                    <div class="w-10 h-10 bg-[#25D366] rounded-full flex items-center justify-center text-white shadow-sm font-bold">W</div>
                    <div>
                      <p class="text-xs font-bold text-gray-800">WhatsApp Business</p>
                      <p class="text-[10px] text-gray-500">Online</p>
                    </div>
                  </div>
                  <div class="max-w-[90%] self-start">
                    <div class="bg-white p-4 rounded-tr-2xl rounded-br-2xl rounded-bl-2xl shadow-sm relative mb-2">
                      <p class="text-sm text-gray-800 leading-relaxed whitespace-pre-wrap">
                        {{ renderedTemplate()?.content }}
                      </p>
                      <p class="text-[10px] text-gray-400 text-right mt-1">10:45</p>
                      <div class="absolute -left-2 top-0 w-3 h-3 bg-white rotate-45 transform origin-top-right"></div>
                    </div>
                    @if (selectedTemplate()?.buttons?.length) {
                      @for (btn of selectedTemplate()?.buttons ?? []; track btn) {
                        <div class="bg-white border-t border-gray-50 rounded-xl py-3 px-4 shadow-sm flex items-center justify-center gap-2 mb-1.5 cursor-default hover:bg-gray-50 transition-colors">
                          <span class="material-symbols-outlined text-sm text-purple-700">open_in_new</span>
                          <span class="text-xs font-semibold text-purple-700 uppercase tracking-tight">{{ btn }}</span>
                        </div>
                      }
                    }
                  </div>
                </div>
              }
            </div>
          </div>
        }
      </div>
    </div>
  }
</div>
